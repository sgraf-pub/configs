---
- name: Remove duperemove
  ansible.builtin.dnf:
    name: duperemove
    state: absent
- name: Remove timers
  ansible.builtin.systemd_service:
    name: duperemove-weekly@-.timer
    state: stopped
    enabled: false
- name: Install bees
  ansible.builtin.dnf:
    name: bees
    state: present
- name: Get UUID for dm-0
  ansible.builtin.command: blkid /dev/dm-0 -s UUID -o value
  register: duperemove_uuid
  changed_when: false
- name: Create bees config file
  ansible.builtin.copy:
    content: |
             UUID={{ duperemove_uuid.stdout }}
             DB_SIZE=$((256*1024*1024))
             OPTIONS="--verbose=5"
    dest: /etc/bees/root.conf
    mode: "0644"
- name: Get low power cores
  ansible.builtin.command: cat /sys/devices/cpu_atom/cpus
  register: linux_lowpower
  changed_when: false
- name: Create override directory
  ansible.builtin.file:
    path: "/etc/systemd/system/beesd@.service.d/"
    state: directory
    mode: '0755'
- name: Set affinity for beesd
  ansible.builtin.copy:
    content: |
             [Service]
             CPUAffinity={{ linux_lowpower.stdout }}
    dest: "/etc/systemd/system/beesd@.service.d/affinity.conf"
    mode: "0644"
- name: Enable bees
  ansible.builtin.systemd_service:
    name: beesd@{{ duperemove_uuid.stdout }}.service
    state: started
    enabled: true
